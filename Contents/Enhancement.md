# 图像增强
[TOC]

## 直方图归一化（ Histogram Normalization ）
有些图像的像素值的值域范围并未在$[0,255]$内，而是在$[0,255]$的子区间内。图像按原始像素值显示时，肉眼看上去往往不是很清晰。可以通过直方图归一化的方式，将它的像素分布从$[0,255]$的子区间变为$[0,255]$范围内。通过这样的方式，可以增加图像显示的清晰度。
直方图归一化的操作被称作**灰度变换（Grayscale Transformation）**。将像素点的取值范围从$[c,d]$变换到$[a,b]$的过程由下式定义。这回我们将`imori_dark.jpg`的灰度扩展到$[0, 255]$范围：
$$
x_{out}=
\begin{cases}
a& (\text{if}\quad x_{in}<c)\\
\frac{b-a}{d-c}\ (x_{in}-c)+a&(\text{else if}\quad c\leq x_{in}<d)\\
b&(\text{else})
\end{cases}
$$

## 直方图均衡化（ Histogram Equalization ）
直方图均衡化是使直方图变得更为均一的操作。均衡化操作由以下式子定义。$S$是总的像素数；$Z_{max}$是像素点的最大取值（在这里是$255$）；$h(z)$表示取值为$z$的累积分布函数：
$$
Z' = \frac{Z_{max}}{S} \  \sum\limits_{i=0}^z\ h(i)
$$

## 直方图匹配 (Histogram matching)
直方图均衡化是直方图匹配的一个特例，直方图均衡化的目标直方图为均匀分布的直方图，若目标直方图来自于另一幅图像时，直方图调整的过程即为直方图匹配。直方图匹配相比直方图均衡化，只需将均一的目标直方图累计分布换作一幅图像的直方图即可。

## 线性拉伸
扩大图像的动态范围（dynamic range），可以拉大不同像素值显示时的色彩区分度，在一定程度上可以提高图像显示的细节。图像拉伸后，图像直方图会变得更为稀疏。线性拉伸可以使用下式完成：
$$
x'=\frac{255-0}{x_{max}-x_{min}}\  (x-x_{min})+0
$$

## 2%线性拉伸
线性拉伸能够在一定程度上扩大了图像的动态范围，在观察自然图像的直方图时，图像在值域$[x_{min},x_{max}]$的两端占有的像素个数往往偏少。若压缩图像值域区间，则拉伸比例会更大，更有利于拉大图像显示色彩的差异。一种行之有效的做法时，统计图像直方图，将累积直方图在$2\%$和$98\%$处的像素值设定为线性拉伸的区间，线性拉伸公式即为：
$$
x'=\frac{255-0}{x_{98\%}-x_{2\%}}\ (x-x_{2\%}) + 0
$$
式中$x_{2\%},x_{98\%}$分别为累计直方图在$2\%$和$98\%$处的像素值。

## 阈值二值化（Thresholding）
二值化是将图像使用黑和白两种颜色表示的方法。
我们将灰度的阈值设置为$128$来进行二值化，即： 
$$ y= 
\begin{cases} 
0& (\text{if}\quad y < 128) \\
255& (\text{else}) 
\end{cases} 
$$

## 大津二值化
大津算法，也被称作最大类间方差法，是一种可以自动确定二值化中阈值的算法。

从**类内方差**和**类间方差**的比值计算得来：
- 小于阈值$t$的类记作$0$，大于阈值$t$的类记作$1$；
- $w_0$和$w_1$是被阈值$t$分开的两个类中的像素数占总像素数的比率（满足$w_0+w_1=1$）；
- ${S_0}^2$， ${S_1}^2$是这两个类中像素值的方差；
- $M_0$，$M_1$是这两个类的像素值的平均值；
- $M_t$为图像均值，$M_t=w_0\cdot{M_0}+w_1\cdot{M_1}$

即：

* 类内方差：${S_w}^2=w_0\ {S_0}^2+w_1\  {S_1}^2$
* 类间方差：${S_b}^2 = w_0 \  (M_0 - M_t)^2 + w_1\ (M_1 - M_t)^2 = w_0\  w_1\  (M_0 - M_1) ^2$
* 图像所有像素的方差：${S_t}^2 = {S_w}^2 + {S_b}^2 = \text{常数}$

根据以上的式子，我们用以下的式子计算分离度$X$：

$$
X = \frac{{S_b}^2}{{S_w}^2} = \frac{{S_b}^2}{{S_t}^2 - {S_b}^2}
$$

也就是说： 
$$
\arg\max\limits_{t}\ X=\arg\max\limits_{t}\ {S_b}^2
$$
换言之，如果使${S_b}^2={w_0}\ {w_1}\ (M_0 - M_1)^2$最大，就可以得到最好的二值化阈值$t$。

## 平均池化（Average Pooling）

将图片按照固定大小网格分割，网格内的像素值取网格内所有像素的平均值。

我们将这种把图片使用均等大小网格分割，并求网格内代表值的操作称为**池化（Pooling）**。

池化操作是**卷积神经网络（Convolutional Neural Network）**中重要的图像处理方式。平均池化按照下式定义：
$$
v=\frac{1}{|R|}\  \sum\limits_{i=1}^R\ v_i
$$
把大小为$128\times128$的`imori.jpg`使用$8\times8$的网格做平均池化。

## 最大池化（Max Pooling）

网格内的值不取平均值，而是取网格内的最大值进行池化操作。
